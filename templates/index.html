<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="/favicon.ico" />
  <title>Deck Builder</title>
  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff; --accent:#1f6feb; --muted:#6b7280; --danger:#dc2626; --success:#16a34a;
      --radius:12px; --shadow:0 8px 30px rgba(16,24,40,0.06);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#0f172a;background:var(--bg);-webkit-font-smoothing:antialiased}
    .wrap{max-width:900px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
    h1{margin:0;font-size:20px}
    .card{background:var(--card);padding:18px;border-radius:var(--radius);box-shadow:var(--shadow)}
    .layout{display:grid;grid-template-columns:1fr 320px;gap:18px}
    @media (max-width:860px){.layout{grid-template-columns:1fr}}

    form.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text],select,input[type=file]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef8;background:transparent;font-size:14px}

    .controls{grid-column:1/-1;display:flex;gap:12px;justify-content:flex-end}
    button.primary{background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer;transition:transform .06s ease, box-shadow .06s ease}
    button.primary:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(31,111,235,0.12)}
    button.primary:active{transform:translateY(0) scale(.995);opacity:0.95}
    button.primary[disabled]{opacity:0.6;cursor:not-allowed}

    button.ghost{background:#f8fafc;border:1px solid #e6eef8;padding:8px 12px;border-radius:8px;cursor:pointer;transition:background .12s ease, transform .06s ease}
    button.ghost:hover{background:#eef4ff;transform:translateY(-1px)}
    button.ghost:active{transform:translateY(0) scale(.995)}
    button.ghost:focus{outline:2px solid rgba(37,99,235,0.15); outline-offset:2px}
    button.ghost.flash{background:#e6f0ff; box-shadow:0 8px 20px rgba(37,99,235,0.12); transform:scale(.995)}

    /* overlay spinner */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(7,10,20,0.35);z-index:60}
    .overlay.visible{display:flex}
    .panel{background:var(--card);padding:20px;border-radius:12px;min-width:320px;display:flex;flex-direction:column;gap:12px;align-items:center}
    .big-spinner{width:48px;height:48px;border-radius:50%;border:6px solid rgba(0,0,0,0.06);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #overlayPercent{font-weight:700;margin-top:6px;font-size:18px}

    /* right column */
    .right .card{padding:12px}
    #progressLog{height:300px;overflow:auto;padding:10px;background:#0b1220;color:#e6eef8;border-radius:8px;font-family:monospace;font-size:13px}
    .meta{color:var(--muted);font-size:13px;margin-bottom:8px}
    .deck-box{padding:12px;background:linear-gradient(180deg,#fff,#fbfdff);border-radius:10px;min-height:140px}
    .deck-lines{white-space:pre-wrap;font-family:monospace;font-size:14px}
    .status{font-weight:700}
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Deck Builder</h1>
      <div class="small">Simple server-driven deck builder</div>
    </header>

    <div class="layout">
      <div class="card">
        <form id="deckForm" class="grid" enctype="multipart/form-data">
          <div>
            <label for="commander">Commander</label>
            <input id="commander" name="commander" type="text" placeholder="e.g. Lord of the Nazgul" required />
          </div>
          <div>
            <label for="partner">Partner (optional)</label>
            <input id="partner" name="partner" type="text" placeholder="Partner name" />
          </div>
          <div>
            <label for="theme">Theme (optional)</label>
            <input id="theme" name="theme" type="text" placeholder="e.g. zombies" />
          </div>
          <div>
            <label for="budget">Budget</label>
            <select id="budget" name="budget"><option value="REGULAR">Regular</option><option value="BUDGET">Budget</option><option value="EXPANSIVE">Expansive</option></select>
          </div>

          <div>
            <label for="inventory">Inventory CSV</label>
            <input id="inventory" name="inventory" type="file" accept=".csv" />
            <div class="small" style="margin-top:6px;color:var(--muted)">Optional: upload inventory to use owned cards</div>
          </div>

          <div class="controls">
            <button id="buildBtn" class="primary" type="submit"><span id="buildLabel">Build Deck</span></button>
          </div>
        </form>

        <div style="margin-top:14px">
          <div class="meta">Status: <span id="statusText" class="status">Idle</span></div>
          <div class="deck-box card">
            <div id="result" class="deck-lines">No deck built yet. Click Build Deck to start.</div>
            <div style="margin-top:10px">
              <button id="copyBtn" class="ghost" style="display:none">Copy deck</button>
            </div>
          </div>
        </div>
      </div>

      <div class="right">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:700">Progress log</div>
            <div class="small">Events will appear here</div>
          </div>
          <div id="progressLog">No activity yet.</div>
        </div>
      </div>
    </div>
  </div>

  <div id="overlay" class="overlay">
    <div class="panel">
      <div class="big-spinner" aria-hidden="true"></div>
      <div id="overlayPercent"></div>
      <div id="overlayText">Building deck...</div>
      <div style="display:flex;gap:8px">
        <button id="overlayStop" class="primary" style="background:var(--danger)">Stop</button>
        <button id="overlayClose" class="ghost" style="display:none">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Elements
    const form = document.getElementById('deckForm');
    const buildBtn = document.getElementById('buildBtn');
    const buildLabel = document.getElementById('buildLabel');
    const overlay = document.getElementById('overlay');
    const overlayText = document.getElementById('overlayText');
    const overlayPercent = document.getElementById('overlayPercent');
    const overlayStop = document.getElementById('overlayStop');
    const overlayClose = document.getElementById('overlayClose');
    const resultDiv = document.getElementById('result');
    const statusText = document.getElementById('statusText');
    const progressLog = document.getElementById('progressLog');
    const copyBtn = document.getElementById('copyBtn');

    let currentBuildId = null; let es = null; window.latestResult = null;

    function appendLog(msg){
      const el = document.createElement('div');
      el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      progressLog.appendChild(el);
      progressLog.scrollTop = progressLog.scrollHeight;
    }

    function flashButton(btn){
      try{
        btn.classList.add('flash');
        setTimeout(()=>btn.classList.remove('flash'),350);
      }catch(e){}
    }

    function showOverlay(text){ overlayText.textContent = text; overlay.classList.add('visible'); }
    function hideOverlay(){ overlay.classList.remove('visible'); overlayPercent.textContent = '' }

    function setStatus(txt){ statusText.textContent = txt }

    function enterStarting(){ buildLabel.textContent = 'Starting...'; buildBtn.disabled = true; showOverlay('Starting build...'); setStatus('Starting'); }
    function enterRunning(id){ currentBuildId = id; buildLabel.textContent = 'Stop'; buildBtn.disabled = false; showOverlay('Building deck...'); setStatus('Running'); }
    function exitIdle(){ currentBuildId = null; buildLabel.textContent = 'Build Deck'; buildBtn.disabled = false; hideOverlay(); setStatus('Idle'); }

    function formatDeck(result){
      if (!result || !result.deck) return 'No deck returned.';
      const deck = result.deck; const size = result.deck_size || Object.values(deck).reduce((s,v)=>s+(parseInt(v)||0),0);
      let out = `Deck (${size} cards)\n\n`;
      const lines = Object.entries(deck).sort((a,b)=>a[0].localeCompare(b[0])).map(([name,c])=>`${c} ${name}`);
      out += lines.join('\n');
      if (result.unavailable_cards && result.unavailable_cards.length){ out += '\n\nUnavailable: ' + result.unavailable_cards.join(', '); }
      return out;
    }

    copyBtn.addEventListener('click', async ()=>{
      if (!window.latestResult) { appendLog('Nothing to copy'); return; }
      const deckObj = window.latestResult.deck || {};
      const lines = Object.entries(deckObj).sort((a,b)=>a[0].localeCompare(b[0])).map(([name,count])=>`${count} ${name}`);
      const text = lines.join('\n');
      if (!text) { appendLog('Deck empty, nothing to copy'); return; }
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          appendLog('Deck copied to clipboard');
          flashButton(copyBtn);
          const prior = copyBtn.textContent; copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent=prior,1500);
        } else {
          // fallback
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed'; ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          const ok = document.execCommand('copy');
          ta.remove();
          appendLog(ok ? 'Deck copied to clipboard (fallback)' : 'Copy failed');
          if (ok) flashButton(copyBtn);
          const prior = copyBtn.textContent; copyBtn.textContent= ok ? 'Copied!' : 'Failed'; setTimeout(()=>copyBtn.textContent=prior,1500);
        }
      } catch (err) {
        appendLog('Copy failed: ' + err.message);
      }
    });

    overlayStop.addEventListener('click', async ()=>{
      if (!currentBuildId) return; overlayStop.disabled = true; appendLog('Cancel requested');
      try{ await fetch('/cancel',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({build_id:currentBuildId})}); appendLog('Cancel sent'); }
      catch(e){ appendLog('Cancel failed: '+e.message) }
      overlayStop.disabled = false;
    });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (currentBuildId){ // act as stop
        overlayStop.click(); return;
      }

      // start
      enterStarting(); appendLog('Starting build (sending request)');
      try{
        const fd = new FormData(form);
        const res = await fetch('/start',{method:'POST',body:fd});
        const data = await res.json();
        if (!res.ok){ appendLog('Start failed: '+(data.error||JSON.stringify(data))); setStatus('Error'); exitIdle(); return; }
        const id = data.build_id; appendLog('Build started: '+id); enterRunning(id);

        // SSE
        es = new EventSource(`/events?build_id=${id}`);
        es.addEventListener('progress', ev=>{ try{ const d=JSON.parse(ev.data); appendLog(d.message); setStatus(d.message);
            // parse messages like 'Checking 3/12' to show percent
            const m = (d.message||'').match(/Checking\s*(\d+)\s*\/\s*(\d+)/i);
            if (m){ const cur = parseInt(m[1],10); const tot = parseInt(m[2],10); if (tot>0){ const pct = Math.round((cur/tot)*100); overlayPercent.textContent = `${pct}% (${cur}/${tot})`; } }
        }catch(e){ appendLog(ev.data); } });
        es.addEventListener('request', ev=>{ try{ const d=JSON.parse(ev.data); appendLog('Server requests: '+(d.missing_key||JSON.stringify(d))); }catch(e){ appendLog(ev.data) } });
        es.addEventListener('result', ev=>{ try{ const d=JSON.parse(ev.data).result; window.latestResult=d; resultDiv.textContent = formatDeck(d); copyBtn.style.display='inline-block'; appendLog('Build finished'); setStatus('Finished'); }catch(e){ appendLog('Result parse error'); resultDiv.textContent = ev.data } if (es) es.close(); exitIdle(); });
        es.addEventListener('cancelled', ev=>{ try{ const d=JSON.parse(ev.data||'{}'); appendLog('Cancelled: '+(d.message||'')); setStatus('Cancelled'); resultDiv.textContent=d.message||'Cancelled'; }catch(e){ appendLog('Cancelled') } if(es)es.close(); exitIdle(); });
        es.addEventListener('error', ev=>{ try{ const d=JSON.parse(ev.data||'{}'); appendLog('Error: '+(d.message||'stream error')); setStatus('Error'); }catch(_){ appendLog('Stream error') } if(es) es.close(); exitIdle(); });

      }catch(err){ appendLog('Failed to start: '+err.message); setStatus('Error'); exitIdle(); }
    });
  </script>
</body>
</html>
